# 大纲

1. ## 封面

2. 目录

3. 个人介绍

4. ## 主要业绩

   1. 导航业务开发
      1. UI层架构优化
      2. 自动比例尺
      3. 导航结束页
      4. 路口大图
      5. 平行路切换
      6. 拥堵气泡，避让框架
      7. 途径点
      8. 昼夜模式
      9. 终点AOI
      10. 路线偏好设置
      11. 避堵路线
      12. 一图到底
      13. 自动化集成服务

5. ## 架构能力

   ![2366704771](/Users/guoqi23/Documents/工作/typora-user-images/2366704771.png)

   1. 当时框架结构图 （已知瓶颈；潜在瓶颈）
      1. 百度导航的架构 https://km.sankuai.com/page/1275094003
         1. 结构说明
            1. 由一个导航的工厂类来创建所有的模块，整体是一个树形结构来管理节点
            2. 由一个专业导航模块，开控制导航所有的页面结构，包含生命周期的管理
            3. 通过模块来创建NaviView
            4. 每个功能模块都是按照View管理类，view控制类（都是单例）
         2. 资源：百度导航SDK4-5人
         3. 问题
            1. 会产生代码逻辑复杂，代码量超级大的类，顶层导航所有View的控制类代码量近万行
      2. 我们的架构比百度的架构更混乱
         1. 逻辑交织在一起，牵一发而动全身，
         2. 模块耦合度高，扩展性差
         3. 排查问题困难
   2. 业务需求复杂
      1. 自动比例尺上下游依赖的协同方多，需要导航定位，导航引擎，地图，渲染，C端协作完成。
      2. 导航结束页迭代计划比较模糊，缺少长期的计划
      3. 避让和自动比例尺需要考虑性能，体验，扩展性
   3. 业务方多
      1. 现有业务
         1. 天行健（美团地图）
      2. 接口能力
         1. 打车
         2. 配送
      3. 未来需要考虑的
         1. 开放平台
         2. 美团
   4. 功能和体验迭代成本高（代码量，代码复用度，1 - 骑行代码量/总代码量=复用率）
      1. 骑行代码量
         1. 判断骑行标识+处理逻辑 92行；骑行控件124行；骑行驾车控制切换逻辑129行；共345行
         2. 骑行代码复用率 1 - 345/19733 = 98.25%
   5. 新的接入方接入成本高 （同上）

6. ## 架构能力-目标分析和指标（定性/定量）

   1. 整体目标:支撑导航业务迭代过程中各种业务需求的极致体验，新业务方可以低成本完成适配；
   2. 拆解的业务目标
      1.  实现各种极致体验的业务需求
      2. 不因复杂业务需求折损体验
      3. 支撑未来导航UI层的业务迭代
      4. 支撑不同宿主的不同效果
      5. 迭代低成本投入
      6. 宿主低成本接入
   3. 拆解的技术目标
      1.  性能优化
      2. 接口易用性
      3. 接口可配置性
      4. 框架扩展性
      5. 框架复用性、可复用技术基建
   4. 指标
      1. 性能（CPU和Jank：找找数据）
      2. 代码复用率（宿主低成本接入）
      3. 开发效率（圈复杂度，基建的复用（复用的模块数量，可复用基建数量，可复用基建代码量））
      4. 可配置率（支持配置的模块数量/总模块数）
      5. 扩展性 （模块间的依赖数量/模块的代码量）
      6. 承接需求数量
      7. 交付质量（日BUG率< 0.5,低级缺陷率。。。）
      8. 0delay，0阻塞
      9. 接口能力

7. ## UI层架构优化-方案设计

   1. 整体方案
      1. 生命周期分发：通过导航整体唯一对外NaviView来分发内部统一的
      2. 模块注册制：所有组件模块分层注册到NaviView中统一管理
      3. 消息机制：统一的消息中心，管理消息队列，来注册和分发各模块的消息。
         1. 统一消息分发：由数据驱动的定位更新，诱导信息更新等重要消息会默认分发给所有的模块
         2. 模块间通信：模块之间的通信属于低频通信，采用观察者模式注册分发。
      4. 配置化：各个功能模块由统一的Option来管理配置，配置中心可以方便的对各个功能模块进行管理。

   ![image-20221015180014102](/Users/guoqi23/Documents/工作/typora-user-images/image-20221015180014102.png)

   

8. ## UI层架构优化-方案设计-框架

   1. 主要目标：好的结构保证后续的业务迭代
   2. 分层：通过分层来隔离变化，每一层都具备相同的职能，导航UI层能力分为了2层，底图组件层合上层组件层
      1. 底图组件层：主要包含自车，罗盘，牵引线，路线，起终点，AOI，电子眼，红路灯和功能气泡等展示类控件。
      2. 上层组件层：主要包含诱导面板，光柱图，车道线，全览，底部设置面板和主辅路切换等展示和交互类控件
   3. 模块化：导航SDKUI层采用高度模块化的架构
      - 良好的生命周期管理和高效的模块通信机制
      - 强大的基础逻辑组件，路线组件，导航模式管理组件（驾车/骑行），通用避让框架，昼夜模式分发组建等
   4. 动态化：高度的模块化给导航SDKUI层赋能动态化能力
      - 热插拔：每个模块都可以实现热插拔
      - Horn下发：配置参数可以动态化
      - 数据驱动：自动比例尺，大图，车道线等
   5. 配置化
      - 易用性接口设计
      - 接口高度配置化
      - Option机制
        - 模块开关
        - 功能开关
        - 参数配置
        - 精准匹配

9. ## UI层架构优化-方案设计-业务

   1. 主要目标：好的业务能力可以支撑好的交付质量
   2. 业务复用能力基建
      - 夜间模式
      - 状态机
      - Loading模块
      - 模式切换（骑行）
   3. 模块拆解和组合：途径点模块就是对起终点Marker模块、路线通过组合来低成本实现的。
      1. 路线模块：备选路线和避堵路线的路线处理都是复用路线模块来处理
      2. 镜头模块：自动比例尺，全览，操作态，大图，车头朝向，途径点，自车等复用镜头逻辑（用一个图来表现处理联动关系）

10. ## UI层架构优化-方案设计-避让框架

    1. 主要目标：底图上的气泡元素可以更好的展示在视野内，而不压盖关键元素

       1. 拥堵气泡和备选路线气泡复用避让逻辑

    2. 方案（框架图，拆一下模块）

       点击展开内容

       1.获取路线到屏幕映射坐标序列（所有可以放置的坐标）

       2.配置需要关注的避让元素

       3.气泡本身的所有可能出现的位置

       4.按优先级排序（把需要关注的元素按优先级排序）

       5.对象池缓存模块

       6.屏幕区域检测

       7.计算最佳位置

       8.碰撞检测

       9.结果评分

       10.主路线碰撞检查

       - 线段和矩形对角线是否相交（快速排斥实验和跨立实验）

       11.路线抽稀

       ![image-20221015180352001](/Users/guoqi23/Documents/工作/typora-user-images/image-20221015180352001.png)

       

       1. 性能优化：
          1. 道格拉斯-普克算法对路线抽稀
          2. 跨力试验模型计算交叉
          3. 只关注屏幕范围
          4. 用Hash降低复杂度
          5. 批量映射
          6. 对象池
          7. 频率控制
       2. 扩展性
          1. 优先级可配置
          2. 避让元素管理
          3. 避让算法内聚和扩展性（主路线碰撞逻辑内聚，在用的地方扩展性好）
       3. 得分累加策略

       1. 指标
          1. 性能（性能前后对比，计算时间）
          2. 复用性（两个模块代码量）
          3. 参考自动比例尺指标（避让元素管理）

11. ## UI层架构优化-成果

    1. 指标
       1. 性能（自动比例尺/避让框架CPU；Jank：找找数据）
       2. 代码复用率（宿主低成本接入）
          1. 骑行代码复用率[98.0627%](https://km.sankuai.com/page/1320945728)
          2. 接口复用率100%
       3. 开发效率
          1. 圈复杂度，
          2. 基建的复用
             1. （复用的模块数量，可复用基建数量）
             2. 可复用基建代码量 5589 行，（总代码量19733行）
       4. 可配置率
          1. 所有模块可配置率 31/47 = 65%；
          2. 功能模块可配置率 31/38 = 81%
       5. 扩展性 （模块间的依赖数量/模块的代码量）
       6. 需求数量 
          1. 16个版本，33个需求
          2. 核心需求12个，自动比例尺，路口大图，途径点，昼夜模式，避堵路线等
       7. 质量
          1. 日BUG率< 0.5
          2. 0低级缺陷
       8. 0delay，0阻塞
    2. 成功上打车（放量中）
       1. 从0构建打车场景接口能力
          1. 提供打车接口67个接口

12. ## 自动比例尺-背景

    1. 导航场景单一比例尺无法满足用户需要看清细节或是更远方路况的需求，在一定的时机下放大或缩小比例尺，有利于减少手动操作，降低危险，提升用户体验；
    2. 导航视野中不能看到重要的路线信息（从自车到关注点以及中间的路线，最大化的在展示在屏幕中；）
    3. 对比竞品功能缺失，体验差

13. ## 自动比例尺-目标分析与指标（定性/定量）

    1. 整体目标：导航场景通过流畅的自动缩放比例尺满足用户可以看清更远的路况需求
    2. 拆解的业务目标
       1. 在充分利用屏幕区域展示有效的路线信息。
       2. 用自动缩放比例尺的手段来展
       3. 体验流畅
    3. 拆解的技术目标
       1. 低成本投入
       2. 不会造成额外的体验损失
       3. 迭代效率
    4. 指标
       1. 执行时间，无卡顿
       2. cpu耗时占比/cpu耗电
       3. 策略调整可以及时修改/生效
       4. 0成本的扩展迭代
       5. 变化频率；
       6. 精准避让，0遮挡，0浪费
       7. 变化平滑度

14. ## 自动比例尺-需求分析

    1. 效果定义
       1. 从自车到关注点以及中间的路线，最大化的在展示在屏幕中；
       2. 在变化过程中保障流畅、平滑
       3. 在不同的道路等级下更好的展示道路周边信息
    2. 技术需求
       1. 性能优
       2. 易扩展 
       3. 策略动态

15. ## 自动比例尺-整体方案

    ![image-20221015180557450](/Users/guoqi23/Documents/工作/typora-user-images/image-20221015180557450.png)

    1. 策略控制：
       - 路线上设置关注点，通过缩放比例尺把自车和关注点中间的路线展示在屏幕中
       - 最大最小比例尺，控制边界可以根据道路等级展示更多的道路周边信息

16. ## 自动比例尺-碰撞方案

    1. 碰撞管理：在移动端屏幕区域是非常重要的，所以我们要充分利用屏幕的区域，导航在屏幕上有很多零散的元素，这些零散的元素会把屏幕可视区域变成一个不规则的图形，我们要把不规则的路线放到不规则的屏幕中就需要通过不断碰撞来计算最佳的可视区域。
       1. 扩大避让区域，点的碰撞会不准确，把点扩大成矩形碰撞会更充分

17. ## 自动比例尺-方案-性能优化

    1. 映射控制：把地图上的真实坐标映射到屏幕坐标

       1. 批量坐标映射接口

    2. 节奏控制

       1. 计算降频

          ![image-20221015180728426](/Users/guoqi23/Documents/工作/typora-user-images/image-20221015180728426.png)

       2. 自动比例尺保持逻辑

18. ## 自动比例尺-方案-扩展性

    1. 策略控制：
       1. 一部分比例尺的策略下沉到引擎和服务，迭代效率高，扩展性高
    2. 避让元素管理
       1. 避让元素可注册：诱导面板，底部面板，车速表，光柱图，车道线，其他可配置元素等

19. ## 自动比例尺-方案-流畅度优化

    1. 节奏控制

    - 定位10Hz，自动比例尺变化频率高，效果流畅
    - 比例尺的变速变化
      - 弱化视觉变化感知：在比例尺变化的过程中发现高频的计算会增加性能损耗，低频的计算会让视觉上感知比例尺变化的卡顿，所以对比例尺的变化过程做差分（一次宽度比较大的比例尺变化拆成多次小的变化）
      - 比例尺变化匀速和变速：在实际的过程中，发现匀速的效果在两次比例尺计算的间隔会有不流畅的表现，所以选择每次的差值做递减运算，这样能保证整个的变化过程就会变得非常的流畅

20. ## 自动比例尺-成果与收益

    点击展开内容

    1. 对应指标
    2. 对比竞品优势
    3. 专利
    4. 其他资料（佐证）

    

    1. 最优比例尺的单次计算控制在30ms以内，避免了主线程的阻塞
    2. 自动比例尺CPU使用率仅增加[0.566%](https://km.sankuai.com/page/1209586105)
    3. 关注点和最大最小比例尺通过服务配置，迭代效率高
    4. 0成本适配打车和骑行
    5. 对比业界方案在比例尺变化上更丝滑，已申请优化效果的专利

21. ## 自动化集成-背景

    1. 导航SDK是一个中间组件上下游都有依赖的组件，所以在交付链路上需要经常跟协同方对齐版本号，如果链路上有版本更新，需要下游串联的更新版本，协同成本比较高，并且沟通不充分还有版本号错误的情况，影响交付质量。

22. ## 自动化集成-目标

    1. 业务目标
       1. 降低协同成本
       2. 使用成本低
    2. 技术目标
       1. 扩展性
       2. 稳定性
       3. 安全性
       4. 低成本投入
    3. 指标
       1. 执行时间
       2. 一次版本升级协同方数量
       3. 手动执行次数

23. ## 自动化集成-方案设计

    1. 整体方案
       1. 分支管理：通过注册好的分支映射关系构建，对于未注册的分支不处理提升安全性
       2. 版本周期管理：对分支设定有效时间，超过有效时间将不触发串联构建

    

    ![image-20221015180901330](/Users/guoqi23/Documents/工作/typora-user-images/image-20221015180901330.png)

    

24. ## 自动化集成-方案-主流程

    1. 使用成本低：
       1. 使用HPXHook的方式，业务方接入学习成本低
       2. 使用串联的方式自动打包，降低人工介入成本
    2. 稳定性

25. ## 自动化集成-方案-稳定性/扩展性

26. ## 自动化集成-成果与收益

    1. 打包平均时长降低36.8%
    2. 一次版本升级的协同方由5个降低到1个；从原来的定位，tbt，地图，导航SDK，统一导航5方协同，变成了谁升级谁触发，每个业务方都可以自己触发。
    3. 打包链路人工手动参与环节从4次降低到1次。

27. 自动化集成-未来规划

28. 结束页